// @ngnjs/net v1.0.0-alpha.23
// Copyright (c) 2021 Corey Butler
// Released under the MIT License.
import{U as URL_PATTERN,c as coalesceb$1,a as cacheStatusCodes,H as HTTP_REDIRECT,R as REDIRECTS,b as Reference,HOSTNAME,d as coalesce$1}from"./index.js";import http from"http";import https from"https";const NGN=(new Reference).requires("runtime","WARN","hidden");let POLYFILLED=!1,hostname=HOSTNAME,cache={get:()=>{},put:(req,res)=>res,capture(){}},SRI={verify:()=>!1};function ReferrerPolicy(policy){this.policy=policy}function result(result){return Object.defineProperties(result,{JSON:{enumerable:!0,get(){try{return JSON.parse(result.responseText)}catch(e){return null}}},body:{get:()=>result.responseText}}),result}function cleanResponse(res,status,responseText="",statusText=""){const r={status:status=coalesce$1(status,res.statusCode,res.status,500),statusText:coalesceb$1(res.statusMessage,res.statusText,http.STATUS_CODES[status]),responseText:coalesceb$1(res.responseText,status>=300?http.STATUS_CODES[status]:res.responseText)||"",headers:res.headers,trailers:res.trailers,url:res.url};return res.redirected&&(r.redirected=res.redirected),res.request&&Object.defineProperty(r,"request",{enumerable:!1,configurable:!1,writable:!1,value:res.request}),r}ReferrerPolicy.prototype.referrerURL=uri=>uri,(async()=>{try{const polyfills=await import("@ngnjs/libnet-node");SRI=polyfills.SRI,ReferrerPolicy=polyfills.ReferrerPolicy,cache=new polyfills.Cache(coalesce$1(process.env.HTTP_CACHE_DIR,"memory")),hostname=polyfills.HOSTNAME,POLYFILLED=!0}catch(e){NGN.WARN("fetch",e)}})();export default function Fetch(resource,init={}){return resource instanceof URL||(resource=URL_PATTERN.test(resource)?new URL(resource):new URL(`http://${hostname}/${resource}`)),new Promise((resolve,reject)=>{let referrer=coalesceb$1(init.referrer,"http://"+hostname);referrer=URL_PATTERN.test(referrer)?new URL(referrer):new URL(`http://${hostname}/${referrer}`),init.referrer=new ReferrerPolicy(init.referrerPolicy).referrerURL(referrer.href,resource.href)||"",init.referrer.trim().length>0&&(init.headers=init.headers||{},init.headers.Referer=init.referrer);const signal=init.signal;delete init.signal;const req=("https:"===resource.protocol?https:http).request(resource.href,init,res=>{let body="";res.setEncoding("utf8"),res.on("data",c=>{body+=c}),res.on("end",()=>{if(cacheStatusCodes.has(res.statusCode)){const response=cache.get(resource.toString());return resolve(response?result(response):cache.put(req,cleanResponse(res,500,"Failed to retrieve cached response."),init.cache))}if(HTTP_REDIRECT.has(res.statusCode)){switch(init.redirect){case"manual":return resolve(result(cleanResponse(res)));case"follow":return res.headers.location?init[REDIRECTS]>=10?resolve(result(cache.put(req,cleanResponse(res,500,"Too many redirects"),init.cache))):(init[REDIRECTS]++,Fetch(res.headers.location,init).then(r=>{r.redirected=!0,r.url=res.headers.location,resolve(result(cache.put(req,cleanResponse(r),init.cache)))}).catch(reject)):resolve(result(cache.put(req,cleanResponse(res,502),init.cache)))}return reject(new Error(`Refused to redirect ${resource.toString()} -> ${res.headers.location||"Unknown/Missing Location"}`))}if(init.integrity){const integrity=SRI.verify(init.integrity,body);if(!integrity.valid)return reject(new Error(integrity.reason))}res.responseText=body,"HEAD"===init.method&&(res.responseText=""),res.request=Object.assign({},init,{url:resource.href});const r=cache.put(req,cleanResponse(res));resolve(result(r))})});if(signal&&"function"==typeof signal&&signal(req),req.on("error",reject),req.on("timeout",()=>{req.destroy(),reject(new Error("Timed out."))}),req.setNoDelay(!0),init.body&&req.write(init.body),"reload"!==init.cache&&"no-cache"!==init.cache){const cached=cache.get(req,init.cache);if(cached)return"function"==typeof req.destroy?req.destroy():"function"==typeof req.abort&&req.abort(),resolve(cached.response);cache.capture(req,init.cache)}req.end()})}export{POLYFILLED};
//# sourceMappingURL=../net-debug/node-7edb1ea2.js.map
